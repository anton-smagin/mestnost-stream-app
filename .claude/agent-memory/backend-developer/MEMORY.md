# Backend Developer Agent Memory

## Project: Label Stream
Working directory: `/workspace/backend/`

## Key File Locations
- Models: `app/models/` — all inherit `TimestampMixin, Base` (in that order)
- Config: `app/core/config.py` — `settings` object, `database_url` (async), `database_url_sync`
- Alembic env: `alembic/env.py` — imports `from app.models import Base` to trigger all model imports
- Main app: `app/main.py` — FastAPI instance, router stubs commented out
- Tests: `tests/conftest.py` — async client fixture using `ASGITransport`

## Model Patterns (SQLAlchemy 2.0)
- All models: `class Foo(TimestampMixin, Base):` — TimestampMixin provides `id` (UUID), `created_at`, `updated_at`
- Use `Mapped[]` type annotations and `mapped_column()` for all columns
- UUID FKs: `mapped_column(UUID(as_uuid=True), ForeignKey("table.id", ondelete="CASCADE"), nullable=False)`
- GIN trigram index: `Index('ix_name_trgm', 'col', postgresql_using='gin', postgresql_ops={'col': 'gin_trgm_ops'})`
- `__table_args__` is a tuple even for single entries: `(Index(...),)`
- Use `TYPE_CHECKING` guard for relationship type annotations to avoid circular imports

## Migration Patterns
- Always add `op.execute("CREATE EXTENSION IF NOT EXISTS pg_trgm")` at top of `upgrade()` for trgm indexes
- Rewrite autogenerated migration to fix lint: use `from collections.abc import Sequence`, `str | None` union syntax, split long lines
- Run `uv run alembic revision --autogenerate -m "description"` then review before applying

## Known Issues / Gotchas
- bcrypt 5.0.0 (installed) has a breaking API change — passlib's CryptContext bcrypt backend fails at runtime
  - Workaround: use `import bcrypt` directly: `bcrypt.hashpw(plain.encode("utf-8"), bcrypt.gensalt()).decode("utf-8")`
  - This affects `scripts/seed_db.py` and will affect any auth service using passlib
- `uv run ruff check` exits 1 even on "All checks passed!" when there are deprecation warnings — check stdout for "All checks passed!" rather than exit code

## Seed Script
- Location: `scripts/seed_db.py`
- Uses sync SQLAlchemy engine from `settings.database_url_sync`
- Idempotent via check-before-insert pattern
- Inserts: 3 artists, 6 albums, 30 tracks, 1 test user (test@labelstream.dev / password123)

## Database Schema (all 8 tables)
artists → albums → tracks (cascade delete chain)
users → playlists → playlist_tracks (FK to tracks)
users → likes (FK to tracks)
users → listen_history (FK to tracks)

## Ruff Config
- line-length = 100, target = py312
- Enforces: E, F, I, N, UP, B, A, SIM rules
- Use `from collections.abc import Sequence` not `from typing import Sequence` (UP035)
- Use `X | Y` union syntax not `Union[X, Y]` (UP007)
